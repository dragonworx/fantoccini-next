var Ae=Object.defineProperty;var Ie=(s,e,t)=>e in s?Ae(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var p=(s,e,t)=>Ie(s,typeof e!="symbol"?e+"":e,t);import"../chunks/CWj6FrbW.js";import"../chunks/2Bu6a_Br.js";import{o as Ge,a as Ce}from"../chunks/DRmIJLM6.js";import{a5 as Le,b as Be,s as ae,h as T,K as ke,a as $e,o as n,an as Se,r as Oe,c as He,d as he,e as ne,i as q,a7 as Re,ab as ze,f as xe,g as Me,p as Ve,ay as le,af as we,a2 as fe,az as Ye,D as I,aA as de,aB as Ue,aC as Fe,ae as Ke,aD as qe,aE as Je,aF as Xe,aG as Ze,a8 as Qe,O as We,aH as je,aI as es,aJ as ss,aK as ts,aL as is,aM as rs,m as as,ai as ns,Y as ls,w as Q,A as b,Z as us,y as X,z as Z,_ as os,x as N,B as w,F as y}from"../chunks/BliMQmZ6.js";import{b as vs,l as cs,e as $,s as O}from"../chunks/gbrRaw8B.js";import{i as me}from"../chunks/Dwdb2LrM.js";import{i as _s}from"../chunks/C-BLvDng.js";function ps(s,e){return e}function hs(s,e,t,i){for(var r=[],l=e.length,c=0;c<l;c++)Fe(e[c].e,r,!0);var d=l>0&&r.length===0&&t!==null;if(d){var S=t.parentNode;Ke(S),S.append(t),i.clear(),H(s,e[0].prev,e[l-1].next)}qe(r,()=>{for(var g=0;g<l;g++){var a=e[g];d||(i.delete(a.k),H(s,a.prev,a.next)),Je(a.e,!d)}})}function fs(s,e,t,i,r,l=null){var c=s,d={flags:e,items:new Map,first:null};{var S=s;c=T?ae(ke(S)):S.appendChild(Le())}T&&$e();var g=null,a=!1,v=Se(()=>{var u=t();return We(u)?u:u==null?[]:we(u)});Be(()=>{var u=n(v),f=u.length;if(a&&f===0)return;a=f===0;let h=!1;if(T){var B=Oe(c)===He;B!==(f===0)&&(c=he(),ae(c),ne(!1),h=!0)}if(T){for(var G=null,_,M=0;M<f;M++){if(q.nodeType===Re&&q.data===ze){c=q,h=!0,ne(!1);break}var k=u[M],P=i(k,M);_=Ne(q,d,G,null,k,P,M,r,e,t),d.items.set(P,_),G=_}f>0&&ae(he())}T||ds(u,d,c,r,e,i,t),l!==null&&(f===0?g?xe(g):g=Me(()=>l(c)):g!==null&&Ve(g,()=>{g=null})),h&&ne(!0),n(v)}),T&&(c=q)}function ds(s,e,t,i,r,l,c){var d=s.length,S=e.items,g=e.first,a=g,v,u=null,f=[],h=[],B,G,_,M;for(M=0;M<d;M+=1){if(B=s[M],G=l(B,M),_=S.get(G),_===void 0){var k=a?a.e.nodes_start:t;u=Ne(k,e,u,u===null?e.first:u.next,B,G,M,i,r,c),S.set(G,u),f=[],h=[],a=u.next;continue}if(ms(_,B,M),_.e.f&le&&xe(_.e),_!==a){if(v!==void 0&&v.has(_)){if(f.length<h.length){var P=h[0],E;u=P.prev;var V=f[0],R=f[f.length-1];for(E=0;E<f.length;E+=1)be(f[E],P,t);for(E=0;E<h.length;E+=1)v.delete(h[E]);H(e,V.prev,R.next),H(e,u,V),H(e,R,P),a=P,u=R,M-=1,f=[],h=[]}else v.delete(_),be(_,a,t),H(e,_.prev,_.next),H(e,_,u===null?e.first:u.next),H(e,u,_),u=_;continue}for(f=[],h=[];a!==null&&a.k!==G;)a.e.f&le||(v??(v=new Set)).add(a),h.push(a),a=a.next;if(a===null)continue;_=a}f.push(_),u=_,a=_.next}if(a!==null||v!==void 0){for(var z=v===void 0?[]:we(v);a!==null;)a.e.f&le||z.push(a),a=a.next;var F=z.length;if(F>0){var K=d===0?t:null;hs(e,z,K,S)}}fe.first=e.first&&e.first.e,fe.last=u&&u.e}function ms(s,e,t,i){Ye(s.v,e),s.i=t}function Ne(s,e,t,i,r,l,c,d,S,g){var a=(S&Xe)!==0,v=(S&Ze)===0,u=a?v?I(r,!1,!1):de(r):r,f=S&Ue?de(c):c,h={i:f,v:u,k:l,a:null,e:null,prev:t,next:i};try{return h.e=Me(()=>d(s,u,f,g),T),h.e.prev=t&&t.e,h.e.next=i&&i.e,t===null?e.first=h:(t.next=h,t.e.next=h.e),i!==null&&(i.prev=h,i.e.prev=h.e),h}finally{}}function be(s,e,t){for(var i=s.next?s.next.e.nodes_start:t,r=e?e.e.nodes_start:t,l=s.e.nodes_start;l!==i;){var c=Qe(l);r.before(l),l=c}}function H(s,e,t){e===null?s.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}function bs(s,e,t){var i=s==null?"":""+s;return i=i?i+" "+e:e,i===""?null:i}function gs(s,e,t,i,r,l){var c=s.__className;if(T||c!==t||c===void 0){var d=bs(t,i);(!T||d!==s.getAttribute("class"))&&(d==null?s.removeAttribute("class"):s.className=d),s.__className=t}return l}const ys=Symbol("is custom element"),Ss=Symbol("is html");function Y(s){if(T){var e=!1,t=()=>{if(!e){if(e=!0,s.hasAttribute("value")){var i=s.value;ve(s,"value",null),s.value=i}if(s.hasAttribute("checked")){var r=s.checked;ve(s,"checked",null),s.checked=r}}};s.__on_r=t,je(t),vs()}}function ve(s,e,t,i){var r=xs(s);T&&(r[e]=s.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&s.nodeName==="LINK")||r[e]!==(r[e]=t)&&(e==="loading"&&(s[es]=t),t==null?s.removeAttribute(e):typeof t!="string"&&Ms(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function xs(s){return s.__attributes??(s.__attributes={[ys]:s.nodeName.includes("-"),[Ss]:s.namespaceURI===ss})}var ge=new Map;function Ms(s){var e=ge.get(s.nodeName);if(e)return e;ge.set(s.nodeName,e=[]);for(var t,i=s,r=Element.prototype;r!==i;){t=is(i);for(var l in t)t[l].set&&e.push(l);i=ts(i)}return e}function U(s,e,t=e){var i=rs();cs(s,"input",r=>{var l=r?s.defaultValue:s.value;if(l=ue(s)?oe(l):l,t(l),i&&l!==(l=e())){var c=s.selectionStart,d=s.selectionEnd;s.value=l??"",d!==null&&(s.selectionStart=c,s.selectionEnd=Math.min(d,s.value.length))}}),(T&&s.defaultValue!==s.value||as(e)==null&&s.value)&&t(ue(s)?oe(s.value):s.value),ns(()=>{var r=e();ue(s)&&r===oe(s.value)||s.type==="date"&&!r&&!s.value||r!==s.value&&(s.value=r??"")})}function ue(s){var e=s.type;return e==="number"||e==="range"}function oe(s){return s===""?null:+s}class J{constructor(e,t){p(this,"lower");p(this,"upper");this.upper=e,this.lower=t}static C(){return new J(4,4)}}class ye{constructor(e){p(this,"bpm");p(this,"timeSignature");p(this,"subDivisions");p(this,"customGrouping");p(this,"variableSubDivisions");this.bpm=e.bpm,this.timeSignature=e.timeSignature??J.C(),this.subDivisions=e.subDivisions??1,this.customGrouping=e.customGrouping,this.variableSubDivisions=e.variableSubDivisions}get pulsesPerMeasure(){if(this.customGrouping){const e=this.customGrouping.reduce((i,r)=>i+r,0),t=this.variableSubDivisions?this.variableSubDivisions.reduce((i,r)=>i+r,0):this.subDivisions;return e*t}return this.timeSignature.upper*this.subDivisions}}class ws{constructor(e){p(this,"pulse");p(this,"pulses");p(this,"subdivs");p(this,"complete");p(this,"measure");p(this,"beat");p(this,"isNewBeat");this.pulse=e.pulse,this.pulses=e.pulses,this.subdivs=e.subdivs,this.complete=e.complete,this.measure=e.measure,this.beat=e.beat,this.isNewBeat=e.isNewBeat}}class Ns{constructor(){p(this,"_pulseController",[]);p(this,"_timer",null);p(this,"_running",!1);p(this,"_expectedNextSysMs",0)}onPulse(e){return this._pulseController.push(e),()=>{const t=this._pulseController.indexOf(e);t!==-1&&this._pulseController.splice(t,1)}}start(e,t){this._running=!0,this._resetTimer(),this._schedulePulse(e,t)}stop(){this._running=!1,this._timer&&(clearTimeout(this._timer),this._timer=null)}pause(){this._running=!1,this._timer&&(clearTimeout(this._timer),this._timer=null)}resume(e,t){this._running=!0,this._schedulePulse(e,t)}_resetTimer(){this._expectedNextSysMs=0,this._timer&&(clearTimeout(this._timer),this._timer=null)}_schedulePulse(e,t){if(!this._running)return;const i=Date.now();this._expectedNextSysMs===0&&(this._expectedNextSysMs=i+e);const r=this._expectedNextSysMs-i;this._timer=setTimeout(()=>{t(),this._expectedNextSysMs+=e,this._schedulePulse(e,t)},Math.max(0,r))}emitPulse(e){for(const t of this._pulseController)t(e)}dispose(){this.stop(),this._pulseController=[]}}class Es{constructor(e){p(this,"settings");p(this,"timer");p(this,"eventListeners",new Set);p(this,"pulseListeners",new Set);p(this,"_isInitialized",!1);p(this,"_pulse",1);p(this,"_measure",1);p(this,"_beat",1);p(this,"_currentGroupIndex",0);this.settings=e,this.timer=new Ns,this.timer.onPulse(t=>{this.pulseListeners.forEach(i=>i(t))})}onEvent(e){return this.eventListeners.add(e),()=>this.eventListeners.delete(e)}onPulse(e){return this.pulseListeners.add(e),()=>this.pulseListeners.delete(e)}async manualPulse(e=1){this._isInitialized||this._initializeMetronome();for(let t=0;t<e;t++)this._onPulse();await Promise.resolve()}_initializeMetronome(){this._resetCounters(),this._isInitialized=!0}start(){this._emitEvent("start"),this._resetCounters(),this.timer.start(this._calculateTempoBeat(),()=>this._onPulse())}stop(){this.timer.stop(),this._emitEvent("stop"),this._resetCounters()}pause(){this.timer.pause(),this._emitEvent("pause")}resume(){this._emitEvent("resume"),this.timer.resume(this._calculateTempoBeat(),()=>this._onPulse())}update(e){this.settings=e,this._resetCounters(),this.timer.stop(),this.timer.start(this._calculateTempoBeat(),()=>this._onPulse()),this._emitEvent("updated")}_resetCounters(){this._pulse=1,this._measure=1,this._beat=1,this._currentGroupIndex=0}_onPulse(){var l;const{settings:e}=this;let t=e.customGrouping&&this._currentGroupIndex<e.customGrouping.length?e.customGrouping[this._currentGroupIndex]:e.timeSignature.upper;const i=e.subDivisions,r=new ws({pulse:this._pulse,pulses:e.pulsesPerMeasure,subdivs:i,complete:(this._pulse-1)/e.pulsesPerMeasure,measure:this._measure,beat:this._beat,isNewBeat:this._pulse%i===1});this.timer.emitPulse(r),this._pulse++,this._pulse>e.pulsesPerMeasure?(this._pulse=1,this._measure++,this._beat=1,this._currentGroupIndex=0):((this._pulse-1)%i===0&&this._beat++,e.timeSignature.upper===12&&i===3?(this._pulse-1)%12===0&&(this._beat=1,this._measure++):this._beat>t&&(this._beat=1,this._currentGroupIndex=(this._currentGroupIndex+1)%(((l=e.customGrouping)==null?void 0:l.length)??1)))}_calculateTempoBeat(){const{bpm:e,subDivisions:t,timeSignature:i}=this.settings;return 6e4/e/t*(4/i.lower)}_emitEvent(e){this.eventListeners.forEach(t=>t(e))}dispose(){this.timer.dispose(),this.eventListeners.clear(),this.pulseListeners.clear()}}var Ds=Q("<div> </div>"),Ts=Q('<div class="pulse-info svelte-14lopyi"><div><strong>Measure:</strong> <strong>Beat:</strong> <strong>Pulse:</strong> <strong>Subdivs:</strong> <strong>isNewBeat:</strong> </div></div>'),Ps=Q('<details><summary> </summary> <pre style="max-height: 200px; overflow: auto;"> </pre></details>'),As=Q('<h1>Metronome Functional Test</h1> <div class="controls svelte-14lopyi"><div class="control-group svelte-14lopyi"><label for="bpm">Tempo (BPM)</label> <input id="bpm" type="number" min="20" max="400"/></div> <div class="control-group svelte-14lopyi"><label for="upper">Time Signature Upper</label> <input id="upper" type="number" min="1" max="32"/></div> <div class="control-group svelte-14lopyi"><label for="lower">Time Signature Lower</label> <input id="lower" type="number" min="1" max="32" step="1"/></div> <div class="control-group svelte-14lopyi"><label for="subDivisions">Subdivisions</label> <input id="subDivisions" type="number" min="1" max="16"/></div> <div class="control-group svelte-14lopyi"><label for="customGrouping">Custom Grouping<br/><small>(comma-separated, e.g. 3,2,2)</small></label> <input id="customGrouping" type="text"/></div> <div class="control-group svelte-14lopyi"><label for="variableSubDivisions">Variable Subdivisions<br/><small>(comma-separated, e.g. 2,3,2)</small></label> <input id="variableSubDivisions" type="text"/></div> <div class="control-group svelte-14lopyi"><button>Start</button> <button>Stop</button></div></div> <div class="pulse-row svelte-14lopyi"></div> <!> <!>',1);function Hs(s,e){ls(e,!1);let t=I(120),i=I(4),r=I(4),l=I(2),c=I(""),d=I(""),S=I(!1),g=I([]),a=I(null),v=null,u=I([]);function f(o){if(o.trim())try{return o.split(",").map(m=>parseInt(m.trim(),10)).filter(m=>!isNaN(m))}catch{return}}function h(){const o=f(n(c)),m=f(n(d)),x=new ye({bpm:n(t),timeSignature:new J(n(i),n(r)),subDivisions:n(l),customGrouping:o&&o.length>0?o:void 0,variableSubDivisions:m&&m.length>0?m:void 0});v&&v.dispose(),v=new Es(x);const C=x.pulsesPerMeasure;y(u,Array.from({length:C},(A,L)=>({pulse:L+1,isActive:!1}))),y(g,[]),y(a,null),v.onPulse(A=>{y(a,A),y(g,[...n(g),A]),y(u,n(u).map((L,D)=>({...L,isActive:D===A.pulse-1})))})}function B(){v||h(),v==null||v.start(),y(S,!0)}function G(){v==null||v.stop(),y(S,!1),y(u,n(u).map(o=>({...o,isActive:!1}))),y(a,null)}function _(){if(!v){h();return}const o=f(n(c)),m=f(n(d)),x=new ye({bpm:n(t),timeSignature:new J(n(i),n(r)),subDivisions:n(l),customGrouping:o&&o.length>0?o:void 0,variableSubDivisions:m&&m.length>0?m:void 0});v.update(x);const C=x.pulsesPerMeasure;y(u,Array.from({length:C},(A,L)=>({pulse:L+1,isActive:!1}))),y(g,[]),y(a,null)}Ge(()=>{h()}),Ce(()=>{v==null||v.dispose()}),_s();var M=As(),k=b(us(M),2),P=N(k),E=b(N(P),2);Y(E),w(P);var V=b(P,2),R=b(N(V),2);Y(R),w(V);var z=b(V,2),F=b(N(z),2);Y(F),w(z);var K=b(z,2),W=b(N(K),2);Y(W),w(K);var j=b(K,2),ee=b(N(j),2);Y(ee),w(j);var se=b(j,2),te=b(N(se),2);Y(te),w(se);var ce=b(se,2),ie=N(ce),_e=b(ie,2);w(ce),w(k);var re=b(k,2);fs(re,5,()=>n(u),ps,(o,m)=>{var x=Ds(),C=N(x,!0);w(x),X(()=>{gs(x,1,`pulse-square ${n(m).isActive?"active":""}`,"svelte-14lopyi"),ve(x,"title",`Pulse ${n(m).pulse??""}`),O(C,n(m).pulse)}),Z(o,x)}),w(re);var pe=b(re,2);{var Ee=o=>{var m=Ts(),x=N(m),C=b(N(x)),A=b(C,2),L=b(A,2),D=b(L,2),Pe=b(D,2);w(x),w(m),X(()=>{O(C,` ${n(a).measure??""}
             |  `),O(A,` ${n(a).beat??""}
             |  `),O(L,` ${n(a).pulse??""}
             |  `),O(D,` ${n(a).subdivs??""}
             |  `),O(Pe,` ${n(a).isNewBeat?"Yes":"No"}`)}),Z(o,m)};me(pe,o=>{n(a)&&o(Ee)})}var De=b(pe,2);{var Te=o=>{var m=Ps(),x=N(m),C=N(x);w(x);var A=b(x,2),L=N(A);w(A),w(m),X(D=>{O(C,`Pulse Log (${n(g).length??""})`),O(L,`${D??""}
    `)},[()=>n(g).map(D=>`M:${D.measure} B:${D.beat} P:${D.pulse} S:${D.subdivs} NewBeat:${D.isNewBeat}`).join(`
`)],Se),Z(o,m)};me(De,o=>{n(g).length>0&&o(Te)})}X(()=>{ie.disabled=n(S),_e.disabled=!n(S)}),U(E,()=>n(t),o=>y(t,o)),$("change",E,_),U(R,()=>n(i),o=>y(i,o)),$("change",R,_),U(F,()=>n(r),o=>y(r,o)),$("change",F,_),U(W,()=>n(l),o=>y(l,o)),$("change",W,_),U(ee,()=>n(c),o=>y(c,o)),$("change",ee,_),U(te,()=>n(d),o=>y(d,o)),$("change",te,_),$("click",ie,B),$("click",_e,G),Z(s,M),os()}export{Hs as component};
